stages:
- test
- build
- build-manifest

variables:
  DOCKER_HOST: tcp://docker:2375
  VERSION: latest
  VERSIONARCH: ${VERSION}-${ARCH}

# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - public/css/app.css
  - public/js/app.js
  - public/js/manifest.js
  - public/js/vendor.js
  - public/*/vendor/
  - node_modules/
  - vendor/

image: docker:latest
services:
- docker:dind

before_script:
- docker info && docker version
- echo "$CI_JOB_TOKEN" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
- if [ -n "$GITHUB_TOKEN" ]; then cat $GITHUB_TOKEN |base64 -d > auth.json; fi

include:
- .gitlab-test.yml
- .gitlab-docker-x86_64.yml
- .gitlab-docker-armv7l.yml
- .gitlab-docker-arm64.yml
- .gitlab-docker-manifest.yml
